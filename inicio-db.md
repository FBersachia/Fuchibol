# Inicio DB

```sql
begin;

do $$
begin
  if not exists (select 1 from pg_type where typname = 'enum_users_role') then
    create type enum_users_role as enum ('admin', 'user');
  end if;
  if not exists (select 1 from pg_type where typname = 'enum_users_gender') then
    create type enum_users_gender as enum ('h', 'm');
  end if;
  if not exists (select 1 from pg_type where typname = 'enum_players_gender') then
    create type enum_players_gender as enum ('h', 'm');
  end if;
  if not exists (select 1 from pg_type where typname = 'enum_matches_status') then
    create type enum_matches_status as enum ('pending', 'completed');
  end if;
  if not exists (select 1 from pg_type where typname = 'enum_group_members_role') then
    create type enum_group_members_role as enum ('admin', 'member');
  end if;
  if not exists (select 1 from pg_type where typname = 'enum_group_invites_type') then
    create type enum_group_invites_type as enum ('general', 'specific');
  end if;
end $$;

create table if not exists public.groups (
  id integer generated by default as identity primary key,
  name varchar(120) not null,
  slug varchar(40) not null unique,
  deleted_at timestamptz null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.users (
  id integer generated by default as identity primary key,
  name varchar(120) not null,
  email varchar(120) not null unique,
  password_hash varchar(255) not null,
  role enum_users_role not null default 'user',
  gender enum_users_gender null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.courts (
  id integer generated by default as identity primary key,
  name varchar(120) not null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.matches (
  id integer generated by default as identity primary key,
  match_date date not null,
  court_id integer null references public.courts(id) on update cascade on delete set null,
  status enum_matches_status not null default 'pending',
  notes text null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.players (
  id integer generated by default as identity primary key,
  name varchar(120) not null,
  gender enum_players_gender not null,
  elo integer not null,
  initial_elo integer not null,
  is_goalkeeper boolean not null default false,
  wins integer not null default 0,
  losses integer not null default 0,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  user_id integer null references public.users(id) on update cascade on delete set null,
  deleted_at timestamptz null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.teams (
  id integer generated by default as identity primary key,
  match_id integer not null references public.matches(id) on update cascade on delete cascade,
  name varchar(120) not null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.team_players (
  id integer generated by default as identity primary key,
  team_id integer not null references public.teams(id) on update cascade on delete cascade,
  player_id integer not null references public.players(id) on update cascade on delete cascade,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint team_players_unique_team_player unique (team_id, player_id)
);

create table if not exists public.match_results (
  id integer generated by default as identity primary key,
  match_id integer not null unique references public.matches(id) on update cascade on delete cascade,
  winning_team_id integer null references public.teams(id) on update cascade on delete set null,
  is_draw boolean not null default false,
  goal_diff integer not null default 0,
  mvp_player_id integer null references public.players(id) on update cascade on delete set null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.distinctions (
  id integer generated by default as identity primary key,
  match_id integer not null references public.matches(id) on update cascade on delete cascade,
  player_id integer not null references public.players(id) on update cascade on delete cascade,
  type varchar(50) not null,
  notes text null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.elo_history (
  id integer generated by default as identity primary key,
  match_id integer not null references public.matches(id) on update cascade on delete cascade,
  player_id integer not null references public.players(id) on update cascade on delete cascade,
  elo_before integer not null,
  elo_after integer not null,
  delta integer not null,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.app_config (
  id integer generated by default as identity primary key,
  w_elo double precision not null default 1.0,
  w_genero double precision not null default 5.0,
  w_social double precision not null default 0.5,
  gender_tolerance integer not null default 1,
  win_delta integer not null default 100,
  draw_delta integer not null default 0,
  loss_delta integer not null default -100,
  use_social_default boolean not null default true,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.config_history (
  id integer generated by default as identity primary key,
  config_id integer not null references public.app_config(id) on update cascade on delete cascade,
  changed_by integer null references public.users(id) on update cascade on delete set null,
  changes jsonb not null default '{}'::jsonb,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.group_members (
  id integer generated by default as identity primary key,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  user_id integer not null references public.users(id) on update cascade on delete restrict,
  role enum_group_members_role not null default 'member',
  deleted_at timestamptz null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table if not exists public.group_invites (
  id integer generated by default as identity primary key,
  group_id integer not null references public.groups(id) on update cascade on delete restrict,
  player_id integer null references public.players(id) on update cascade on delete set null,
  created_by integer null references public.users(id) on update cascade on delete set null,
  token varchar(120) not null unique,
  type enum_group_invites_type not null,
  expires_at timestamptz not null,
  max_uses integer not null,
  used_count integer not null default 0,
  revoked_at timestamptz null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create unique index if not exists players_unique_group_nickname_active
  on public.players (group_id, name)
  where deleted_at is null;

create unique index if not exists group_members_unique_active
  on public.group_members (group_id, user_id)
  where deleted_at is null;

create unique index if not exists app_config_unique_group
  on public.app_config (group_id);

commit;
```

## Seed inicial

```sql
begin;

with upsert_group as (
  insert into public.groups (name, slug, created_at, updated_at)
  values ('Fuchibol oculto', 'fuchiboloculto', now(), now())
  on conflict (slug) do update
    set name = excluded.name,
        updated_at = now()
  returning id
),
group_row as (
  select coalesce(
    (select id from upsert_group),
    (select id from public.groups where slug = 'fuchiboloculto' limit 1)
  ) as id
),
upsert_user as (
  insert into public.users (name, email, password_hash, role, gender, created_at, updated_at)
  values (
    'Francisco',
    'fbersachia@gmail.com',
    '$2b$10$7dkz/HS/aIp/HFYVtEiYoe1oxobaZ1Rxg.IzrTrCD0VrlIEs2WWVO',
    'admin',
    'h',
    now(),
    now()
  )
  on conflict (email) do update
    set name = excluded.name,
        password_hash = excluded.password_hash,
        role = 'admin',
        gender = excluded.gender,
        updated_at = now()
  returning id
),
user_row as (
  select coalesce(
    (select id from upsert_user),
    (select id from public.users where email = 'fbersachia@gmail.com' limit 1)
  ) as id
)
insert into public.group_members (group_id, user_id, role, created_at, updated_at)
select g.id, u.id, 'admin', now(), now()
from group_row g
cross join user_row u
on conflict (group_id, user_id) where deleted_at is null
do update set role = 'admin', updated_at = now();

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
user_row as (
  select id from public.users where email = 'fbersachia@gmail.com' limit 1
),
players as (
  values
    ('Jota', 'h', 700),
    ('Beder', 'm', 300),
    ('Lorenzo', 'h', 800),
    ('Taigo', 'h', 1000),
    ('Aldara', 'm', 500),
    ('Bregus', 'h', 400),
    ('Luko', 'h', 900),
    ('Francisco', 'h', 900),
    ('Kami', 'm', 600),
    ('Garita', 'm', 500),
    ('Mauri', 'h', 600),
    ('Nati', 'm', 300)
)
insert into public.players (
  name,
  gender,
  elo,
  initial_elo,
  is_goalkeeper,
  wins,
  losses,
  group_id,
  user_id,
  created_at,
  updated_at
)
select
  p.column1,
  p.column2::enum_players_gender,
  p.column3,
  p.column3,
  false,
  0,
  0,
  g.id,
  case when p.column1 = 'Francisco' then u.id else null end,
  now(),
  now()
from players p
cross join group_row g
left join user_row u on true
on conflict (group_id, name) where deleted_at is null
do update set
  gender = excluded.gender,
  elo = excluded.elo,
  initial_elo = excluded.initial_elo,
  user_id = excluded.user_id,
  updated_at = now();

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
)
insert into public.courts (name, group_id, created_at, updated_at)
select 'El viejo estadio', g.id, now(), now()
from group_row g
where not exists (
  select 1 from public.courts c where c.group_id = g.id and c.name = 'El viejo estadio'
);

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
court_row as (
  select c.id
  from public.courts c
  join group_row g on c.group_id = g.id
  where c.name = 'El viejo estadio'
  limit 1
)
insert into public.matches (
  match_date,
  court_id,
  status,
  notes,
  group_id,
  created_at,
  updated_at
)
select date '2026-01-19', c.id, 'completed', null, g.id, now(), now()
from group_row g
cross join court_row c
where not exists (
  select 1
  from public.matches m
  where m.group_id = g.id
    and m.match_date = date '2026-01-19'
    and m.court_id = c.id
);

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
match_row as (
  select m.id
  from public.matches m
  join public.courts c on m.court_id = c.id
  join group_row g on m.group_id = g.id
  where m.match_date = date '2026-01-19'
    and c.name = 'El viejo estadio'
  order by m.id
  limit 1
),
team_names as (
  values ('Equipo Negro'), ('Equipo Blanco')
)
insert into public.teams (match_id, name, group_id, created_at, updated_at)
select m.id, t.column1, g.id, now(), now()
from match_row m
cross join group_row g
cross join team_names t
where not exists (
  select 1 from public.teams tm where tm.match_id = m.id and tm.name = t.column1
);

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
match_row as (
  select m.id
  from public.matches m
  join public.courts c on m.court_id = c.id
  join group_row g on m.group_id = g.id
  where m.match_date = date '2026-01-19'
    and c.name = 'El viejo estadio'
  order by m.id
  limit 1
),
team_rows as (
  select t.id, t.name
  from public.teams t
  join match_row m on t.match_id = m.id
),
player_rows as (
  select p.id, p.name
  from public.players p
  join group_row g on p.group_id = g.id
),
assignments as (
  values
    ('Equipo Negro', 'Jota'),
    ('Equipo Negro', 'Beder'),
    ('Equipo Negro', 'Lorenzo'),
    ('Equipo Negro', 'Taigo'),
    ('Equipo Negro', 'Aldara'),
    ('Equipo Negro', 'Bregus'),
    ('Equipo Blanco', 'Luko'),
    ('Equipo Blanco', 'Francisco'),
    ('Equipo Blanco', 'Kami'),
    ('Equipo Blanco', 'Garita'),
    ('Equipo Blanco', 'Mauri'),
    ('Equipo Blanco', 'Nati')
)
insert into public.team_players (team_id, player_id, group_id, created_at, updated_at)
select t.id, p.id, g.id, now(), now()
from assignments a
join team_rows t on t.name = a.column1
join player_rows p on p.name = a.column2
cross join group_row g
on conflict (team_id, player_id) do nothing;

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
match_row as (
  select m.id
  from public.matches m
  join public.courts c on m.court_id = c.id
  join group_row g on m.group_id = g.id
  where m.match_date = date '2026-01-19'
    and c.name = 'El viejo estadio'
  order by m.id
  limit 1
),
team_row as (
  select t.id
  from public.teams t
  join match_row m on t.match_id = m.id
  where t.name = 'Equipo Negro'
  limit 1
),
player_row as (
  select p.id
  from public.players p
  join group_row g on p.group_id = g.id
  where p.name = 'Jota'
  limit 1
)
insert into public.match_results (
  match_id,
  winning_team_id,
  is_draw,
  goal_diff,
  mvp_player_id,
  group_id,
  created_at,
  updated_at
)
select m.id, t.id, false, 1, p.id, g.id, now(), now()
from match_row m
cross join team_row t
cross join player_row p
cross join group_row g
on conflict (match_id) do update set
  winning_team_id = excluded.winning_team_id,
  is_draw = excluded.is_draw,
  goal_diff = excluded.goal_diff,
  mvp_player_id = excluded.mvp_player_id,
  group_id = excluded.group_id,
  updated_at = now();

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
match_row as (
  select m.id
  from public.matches m
  join public.courts c on m.court_id = c.id
  join group_row g on m.group_id = g.id
  where m.match_date = date '2026-01-19'
    and c.name = 'El viejo estadio'
  order by m.id
  limit 1
),
player_row as (
  select p.id
  from public.players p
  join group_row g on p.group_id = g.id
  where p.name = 'Jota'
  limit 1
)
insert into public.distinctions (
  match_id,
  player_id,
  type,
  notes,
  group_id,
  created_at,
  updated_at
)
select m.id, p.id, 'mvp', null, g.id, now(), now()
from match_row m
cross join player_row p
cross join group_row g
where not exists (
  select 1
  from public.distinctions d
  where d.match_id = m.id
    and d.player_id = p.id
    and d.type = 'mvp'
    and d.group_id = g.id
);

with group_row as (
  select id from public.groups where slug = 'fuchiboloculto' limit 1
),
match_row as (
  select m.id
  from public.matches m
  join public.courts c on m.court_id = c.id
  join group_row g on m.group_id = g.id
  where m.match_date = date '2026-01-19'
    and c.name = 'El viejo estadio'
  order by m.id
  limit 1
)
update public.matches
set status = 'completed'
where id = (select id from match_row);

commit;
```
